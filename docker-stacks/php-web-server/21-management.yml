version: "3.7"
services:
  minio:
    ports:
      - mode: ingress
        target: 9000
        published: ${MINIO_PORT}
        protocol: tcp

  mongo_express:
    image: mongo-express:latest
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongo
      - ME_CONFIG_MONGODB_PORT=27017
      - ME_CONFIG_MONGODB_ADMINUSERNAME=${BACKING_SERVICES_USER}
      - ME_CONFIG_MONGODB_ADMINPASSWORD=${MONGO_PASSWORD}
      - ME_CONFIG_BASICAUTH_USERNAME=${BACKING_SERVICES_USER}
      - ME_CONFIG_BASICAUTH_PASSWORD=${MONGO_PASSWORD}
    ports:
      - mode: ingress
        target: 8081
        published: ${MONGO_EXPRESS_PORT}
        protocol: tcp
    deploy:
      resources:
        reservations:
          cpus: "0.10"
          memory: 128mb
        limits:
          cpus: "1.00"
          memory: 1gb
      restart_policy:
        condition: any
        delay: "0"
      labels:
        - version=${VERSION}
    labels:
      - version=${VERSION}

  # pgAdmin and PostgreSQL connection have to be configured manually.
  # Open ${PGADMIN_PORT} in your browser, click RMB on the "Servers",
  # hover "Create" and click "Server...".
  # On the "Connection" tab use the following values:
  # Host: postgres
  # Port: 5432
  # User: ${BACKING_SERVICES_USER}
  # Password: ${POSTGRES_PASSWORD}
  pgadmin:
    image: dpage/pgadmin4:latest
    environment:
      - PGADMIN_DEFAULT_EMAIL=${BACKING_SERVICES_USER}
      - PGADMIN_DEFAULT_PASSWORD=${POSTGRES_PASSWORD}
    ports:
      - mode: ingress
        target: 80
        published: ${PGADMIN_PORT}
        protocol: tcp
    volumes:
      - type: volume
        source: pgadmin_config
        target: /var/lib/pgadmin
    deploy:
      resources:
        reservations:
          cpus: "0.10"
          memory: 128mb
        limits:
          cpus: "1.00"
          memory: 1gb
      restart_policy:
        condition: any
        delay: "0"
      labels:
        - version=${VERSION}
    labels:
      - version=${VERSION}

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    environment:
      - PMA_HOST=mysql
      - PMA_PORT=3306
    ports:
      - mode: ingress
        target: 80
        published: ${PHPMYADMIN_PORT}
        protocol: tcp
    deploy:
      resources:
        reservations:
          cpus: "0.10"
          memory: 128mb
        limits:
          cpus: "1.00"
          memory: 1gb
      restart_policy:
        condition: any
        delay: "0"
      labels:
        - version=${VERSION}
    labels:
      - version=${VERSION}

  rabbitmq:
    image: rabbitmq:management
    ports:
      - mode: ingress
        target: 15672
        published: ${RABBITMQ_MANAGEMENT_PORT}
        protocol: tcp

  redis_commander:
    image: rediscommander/redis-commander:latest
    environment:
      - HTTP_USER=${BACKING_SERVICES_USER}
      - HTTP_PASSWORD=${REDIS_PASSWORD}
      - REDIS_HOSTS=session:redis:6379:0:${REDIS_PASSWORD},cache:redis:6379:1:${REDIS_PASSWORD}
    ports:
      - mode: ingress
        target: 8081
        published: ${REDIS_COMMANDER_PORT}
        protocol: tcp
    deploy:
      resources:
        reservations:
          cpus: "0.10"
          memory: 128mb
        limits:
          cpus: "1.00"
          memory: 1gb
      restart_policy:
        condition: any
        delay: "0"
      labels:
        - version=${VERSION}
    labels:
      - version=${VERSION}

volumes:
  pgadmin_config:
    external: true
    name: ${COMPOSE_PROJECT_NAME}_pgadmin_config
